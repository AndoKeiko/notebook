<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenAI API</title>
</head>
<body>
  <h1>GPT-3.5に質問してみよう！</h1>
  <label for="key">API KEY</label>
  <input type="text" id="key">
  <br>
  <label for="text">質問内容</label>
  <input type="text" id="text">
  <button id="btn">質問する！</button>
  <p id="res"></p>
<script>
const btn = document.getElementById('btn');
const text = document.getElementById('text');
const resArea = document.getElementById('res');
const keyInput = document.getElementById('key');
btn.addEventListener('click', async () => {
  const apiKey = keyInput.value;
  let retryCount = 0;
  let success = false;
  while (!success && retryCount < 5) {
    try {
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'post',
        headers: {
          'Content-type': 'application/json',
          'Authorization': 'Bearer ' + apiKey
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [
            {
              role: 'user',
              content: text.value
            }
          ],
        })
      });
      if (res.status === 429) {
        retryCount++;
        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // 指数バックオフ
      } else {
        const data = await res.json();
        if (data.choices && data.choices.length > 0 && data.choices[0].message) {
          resArea.innerHTML = data.choices[0].message.content;
          success = true;
        } else {
          resArea.innerHTML = 'エラーが発生しました。';
          success = true;
        }
      }
    } catch (error) {
      console.error('リクエスト中にエラーが発生しました:', error);
      resArea.innerHTML = 'エラーが発生しました。';
      break;
    }
  }
});
</script>
</body>
</html>